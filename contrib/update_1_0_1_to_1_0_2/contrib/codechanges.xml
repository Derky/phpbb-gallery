<?xml version="1.0" encoding="utf-8" standalone="yes"?>
<?xml-stylesheet type="text/xsl" href="modx.prosilver.en.xsl"?>
<!--For security purposes, please check: http://www.phpbb.com/mods/ for the latest version of this MOD. Although MODs are checked before being allowed in the MODs Database there is no guarantee that there are no security problems within the MOD. No support will be given for MODs not found within the MODs Database which can be found at http://www.phpbb.com/mods/-->
<!-- $Id$ -->
<mod xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns="http://www.phpbb.com/mods/xml/modx-1.2.2.xsd">
	<header>
		<license>http://opensource.org/licenses/gpl-license.php GNU General Public License v2</license>

		<title lang="de">phpBB Gallery</title>
		<title lang="en">phpBB Gallery</title>

		<description lang="de"><![CDATA[Update-Code-Änderungen]]></description>
		<description lang="en"><![CDATA[Update-Code-Changed]]></description>

		<author-notes lang="de"><![CDATA[Es wird dringend empfohlen die update.xml zu benutzen und alle Gallery-Dateien zu überschreiben.]]></author-notes>
		<author-notes lang="en"><![CDATA[It's highly recommanded to use the update.xml and to just over write all gallery files.]]></author-notes>

		<author-group>
			<author>
				<realname>Joas Schilling</realname>
				<email>nickvergessen@gmx.de</email>
				<username>nickvergessen</username>
				<homepage>http://www.flying-bits.org/</homepage>
				<contributions />
			</author>
		</author-group>

		<mod-version>1.0.2</mod-version>

		<installation>
			<level>intermediate</level>
			<time>1200</time>
			<target-version>3.0.5</target-version>
		</installation>

		<link-group>
			<link type="parent" lang="de" href="../../history.xml">Geschichte/Entwickler/Features</link>
			<link type="parent" lang="en" href="../../history.xml">History/Developers/Features</link>
			<link type="parent" lang="de" href="../update.xml">Update von 1.0.1 auf 1.0.2</link>
			<link type="parent" lang="en" href="../update.xml">Update from 1.0.1 to 1.0.2</link>
		</link-group>
	</header>

	<action-group>
		<copy>
			<file from="root/adm/mods/phpbb_gallery_version.php" to="adm/mods/phpbb_gallery_version.php" />
			<file from="root/install/*.*" to="install/*.*" />
			<file from="root/install/schemas/*.*" to="install/schemas/*.*" />
		</copy>

		<open src="gallery/image_page.php">
			<edit>
				<find><![CDATA[				'POST_AUTHOR_FULL'		=> get_username_string('full', $user_cache[$user_id]['user_id'], ($user_cache[$user_id]['user_id'] != ANONYMOUS) ? $user_cache[$user_id]['username'] : ($user->lang['GUEST'] . ': ' . $row['comment_username']), $user_cache[$user_id]['user_colour']),
				'POST_AUTHOR_COLOUR'	=> get_username_string('colour', $user_cache[$user_id]['user_id'], ($user_cache[$user_id]['user_id'] != ANONYMOUS) ? $user_cache[$user_id]['username'] : ($user->lang['GUEST'] . ': ' . $row['comment_username']), $user_cache[$user_id]['user_colour']),
				'POST_AUTHOR'			=> get_username_string('username', $user_cache[$user_id]['user_id'], ($user_cache[$user_id]['user_id'] != ANONYMOUS) ? $user_cache[$user_id]['username'] : ($user->lang['GUEST'] . ': ' . $row['comment_username']), $user_cache[$user_id]['user_colour']),
				'U_POST_AUTHOR'			=> get_username_string('profile', $user_cache[$user_id]['user_id'], ($user_cache[$user_id]['user_id'] != ANONYMOUS) ? $user_cache[$user_id]['username'] : ($user->lang['GUEST'] . ': ' . $row['comment_username']), $user_cache[$user_id]['user_colour']),]]></find>
				<action type="replace-with"><![CDATA[				'POST_AUTHOR_FULL'		=> get_username_string('full', $user_id, $row['comment_username'], $user_cache[$user_id]['user_colour']),
				'POST_AUTHOR_COLOUR'	=> get_username_string('colour', $user_id, $row['comment_username'], $user_cache[$user_id]['user_colour']),
				'POST_AUTHOR'			=> get_username_string('username', $user_id, $row['comment_username'], $user_cache[$user_id]['user_colour']),
				'U_POST_AUTHOR'			=> get_username_string('profile', $user_id, $row['comment_username'], $user_cache[$user_id]['user_colour']),]]></action>
			</edit>
		</open>

		<open src="gallery/posting.php">
			<edit>
				<find><![CDATA[				if ($submit)
				{
					if (!check_form_key('gallery'))
					{
						trigger_error('FORM_INVALID');
					}
					$comment = request_var('message', '', true);
					$comment_text = $comment;
					$comment_username = request_var('username', '');
					if ($comment_data['comment_user_id'] == ANONYMOUS)
					{
						$comment_username_req = true;
					}]]></find>
				<action type="replace-with"><![CDATA[				if ($comment_data['comment_user_id'] == ANONYMOUS)
				{
					$comment_username_req = true;
				}
				if ($submit)
				{
					if (!check_form_key('gallery'))
					{
						trigger_error('FORM_INVALID');
					}
					$sql_ary = array();

					$comment = request_var('message', '', true);
					$comment_text = $comment;]]></action>
			</edit>
			<edit>
				<find><![CDATA[					if ($comment_username_req)
					{]]></find>
				<action type="after-add"><![CDATA[						$comment_username = request_var('username', '');]]></action>
			</edit>
			<edit>
				<find><![CDATA[					}
					if ($comment_text == '')
					{
						$submit = false;
						$error .= (($error) ? '<br />' : '') . $user->lang['MISSING_COMMENT'];
					}]]></find>
				<action type="before-add"><![CDATA[						$sql_ary = array(
							'comment_username'	=> $comment_username,
						);]]></action>
			</edit>
			<edit>
				<find><![CDATA[					$sql_ary = array(
						'comment_username'		=> $comment_username,
						'comment'				=> $message_parser->message]]></find>
				<action type="replace-with"><![CDATA[					$sql_ary = array_merge($sql_ary, array(
						'comment'				=> $message_parser->message,]]></action>
			</edit>
		</open>

		<open src="gallery/search.php">
			<edit>
				<find><![CDATA[					'IMAGE_AUTHOR'			=> get_username_string('full', $commentrow['image_user_id'], ($commentrow['image_user_id'] <> ANONYMOUS) ? $commentrow['image_username'] : ($user->lang['GUEST'] . ': ' . $commentrow['image_username']), $commentrow['image_user_colour']),]]></find>
				<action type="replace-with"><![CDATA[					'IMAGE_AUTHOR'			=> get_username_string('full', $commentrow['image_user_id'], $commentrow['image_username'], $commentrow['image_user_colour']),]]></action>
			</edit>
			<edit>
				<find><![CDATA[					'POST_AUTHOR_FULL'		=> get_username_string('full', $commentrow['comment_user_id'], ($commentrow['comment_user_id'] <> ANONYMOUS) ? $commentrow['comment_username'] : ($user->lang['GUEST'] . ': ' . $commentrow['comment_username']), $commentrow['comment_user_colour']),
					'POST_AUTHOR_COLOUR'	=> get_username_string('colour', $commentrow['comment_user_id'], ($commentrow['comment_user_id'] <> ANONYMOUS) ? $commentrow['comment_username'] : ($user->lang['GUEST'] . ': ' . $commentrow['comment_username']), $commentrow['comment_user_colour']),
					'POST_AUTHOR'			=> get_username_string('username', $commentrow['comment_user_id'], ($commentrow['comment_user_id'] <> ANONYMOUS) ? $commentrow['comment_username'] : ($user->lang['GUEST'] . ': ' . $commentrow['comment_username']), $commentrow['comment_user_colour']),
					'U_POST_AUTHOR'			=> get_username_string('profile', $commentrow['comment_user_id'], ($commentrow['comment_user_id'] <> ANONYMOUS) ? $commentrow['comment_username'] : ($user->lang['GUEST'] . ': ' . $commentrow['comment_username']), $commentrow['comment_user_colour']),]]></find>
				<action type="replace-with"><![CDATA[					'POST_AUTHOR_FULL'		=> get_username_string('full', $commentrow['comment_user_id'], $commentrow['comment_username'], $commentrow['comment_user_colour']),
					'POST_AUTHOR_COLOUR'	=> get_username_string('colour', $commentrow['comment_user_id'], $commentrow['comment_username'], $commentrow['comment_user_colour']),
					'POST_AUTHOR'			=> get_username_string('username', $commentrow['comment_user_id'], $commentrow['comment_username'], $commentrow['comment_user_colour']),
					'U_POST_AUTHOR'			=> get_username_string('profile', $commentrow['comment_user_id'], $commentrow['comment_username'], $commentrow['comment_user_colour']),]]></action>
			</edit>
		</open>

		<open src="gallery/includes/functions.php">
			<edit>
				<find><![CDATA[if (gallery_acl_check('a_list', $row['album_id'], $row['album_user_id']))]]></find>
				<action type="replace-with"><![CDATA[if (gallery_acl_check('a_list', $row['album_id'], $row['album_user_id']) || defined('IN_ADMIN'))]]></action>
			</edit>
		</open>

		<open src="gallery/includes/functions_recent.php">
			<edit>
				<find><![CDATA[				'IMAGE_AUTHOR'			=> get_username_string('full', $commentrow['image_user_id'], ($commentrow['image_user_id'] <> ANONYMOUS) ? $commentrow['image_username'] : ($user->lang['GUEST'] . ': ' . $commentrow['image_username']), $commentrow['image_user_colour']),]]></find>
				<action type="replace-with"><![CDATA[				'IMAGE_AUTHOR'			=> get_username_string('full', $commentrow['image_user_id'], $commentrow['image_username'], $commentrow['image_user_colour']),]]></action>
			</edit>
			<edit>
				<find><![CDATA[				'POST_AUTHOR_FULL'		=> get_username_string('full', $commentrow['comment_user_id'], ($commentrow['comment_user_id'] <> ANONYMOUS) ? $commentrow['comment_username'] : ($user->lang['GUEST'] . ': ' . $commentrow['comment_username']), $commentrow['comment_user_colour']),
				'POST_AUTHOR_COLOUR'	=> get_username_string('colour', $commentrow['comment_user_id'], ($commentrow['comment_user_id'] <> ANONYMOUS) ? $commentrow['comment_username'] : ($user->lang['GUEST'] . ': ' . $commentrow['comment_username']), $commentrow['comment_user_colour']),
				'POST_AUTHOR'			=> get_username_string('username', $commentrow['comment_user_id'], ($commentrow['comment_user_id'] <> ANONYMOUS) ? $commentrow['comment_username'] : ($user->lang['GUEST'] . ': ' . $commentrow['comment_username']), $commentrow['comment_user_colour']),
				'U_POST_AUTHOR'			=> get_username_string('profile', $commentrow['comment_user_id'], ($commentrow['comment_user_id'] <> ANONYMOUS) ? $commentrow['comment_username'] : ($user->lang['GUEST'] . ': ' . $commentrow['comment_username']), $commentrow['comment_user_colour']),]]></find>
				<action type="replace-with"><![CDATA[				'POST_AUTHOR_FULL'		=> get_username_string('full', $commentrow['comment_user_id'], $commentrow['comment_username'], $commentrow['comment_user_colour']),
				'POST_AUTHOR_COLOUR'	=> get_username_string('colour', $commentrow['comment_user_id'], $commentrow['comment_username'], $commentrow['comment_user_colour']),
				'POST_AUTHOR'			=> get_username_string('username', $commentrow['comment_user_id'], $commentrow['comment_username'], $commentrow['comment_user_colour']),
				'U_POST_AUTHOR'			=> get_username_string('profile', $commentrow['comment_user_id'], $commentrow['comment_username'], $commentrow['comment_user_colour']),]]></action>
			</edit>
		</open>

		<open src="gallery/includes/functions_users.php">
			<edit>
				<find><![CDATA[				$diff = $now['mon'] - $bday_month;]]></find>
				<action type="before-add"><![CDATA[				$now = getdate(time() + $user->timezone + $user->dst - date('Z'));

]]></action>
			</edit>
		</open>

		<open src="includes/acp/acp_gallery.php">
			<edit>
				<find><![CDATA[if (strpos($file, 'image_not_exist') || strpos($file, 'not_authorised') || strpos($file, 'no_hotlinking'))]]></find>
				<action type="replace-with"><![CDATA[if ((strpos($file, 'image_not_exist') !== false) || (strpos($file, 'not_authorised') !== false) || (strpos($file, 'no_hotlinking') !== false))]]></action>
			</edit>
		</open>

		<open src="styles/prosilver/template/gallery/plugins_header.html">
			<edit>
				<find><![CDATA[hs.captionEval = 'this.thumb.alt';]]></find>
				<action type="replace-with"><![CDATA[hs.captionEval = 'this.thumb.title';]]></action>
			</edit>
		</open>

		<open src="styles/subsilver2/template/gallery/plugins_header.html">
			<edit>
				<find><![CDATA[hs.captionEval = 'this.thumb.alt';]]></find>
				<action type="replace-with"><![CDATA[hs.captionEval = 'this.thumb.title';]]></action>
			</edit>
		</open>

		<diy-instructions lang="de"><![CDATA[Siehe update.xml für weitere Anweisungen!]]></diy-instructions>
		<diy-instructions lang="en"><![CDATA[See update.xml for further instructions!]]></diy-instructions>
	</action-group>
</mod>